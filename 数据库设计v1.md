# AgentU 数据库设计

## 概述

AgentU系统的完整数据库表结构设计，包含用户管理、会话对话、知识库、AI模型等核心功能模块。

## 表结构设计

### 1. users - 用户表

```sql
CREATE TABLE users (
    -- 主键
    user_id VARCHAR(36) NOT NULL PRIMARY KEY,
    
    -- 基本信息
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    salt VARCHAR(32) NOT NULL,
    
    -- 用户信息
    nickname VARCHAR(100),
    avatar_url VARCHAR(500),
    phone VARCHAR(20),
    
    -- 状态管理
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    email_verified BOOLEAN DEFAULT FALSE,
    phone_verified BOOLEAN DEFAULT FALSE,
    
    -- 偏好设置
    language VARCHAR(10) DEFAULT 'zh-CN',
    timezone VARCHAR(50) DEFAULT 'Asia/Shanghai',
    theme VARCHAR(20) DEFAULT 'light',
    
    -- 配额信息
    token_quota BIGINT DEFAULT 100000,
    token_used BIGINT DEFAULT 0,
    monthly_quota BIGINT DEFAULT 1000000,
    monthly_used BIGINT DEFAULT 0,
    quota_reset_date DATE,
    
    -- 登录信息
    last_login_at TIMESTAMP,
    last_login_ip VARCHAR(45),
    login_count INT DEFAULT 0,
    
    -- 审计字段
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP
);

-- 索引
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_created_at ON users(created_at);
```

### 2. ai_providers - AI服务提供商表

```sql
CREATE TABLE ai_providers (
    -- 主键
    provider_id VARCHAR(36) NOT NULL PRIMARY KEY,
    
    -- 基本信息
    provider_name VARCHAR(100) NOT NULL UNIQUE,
    provider_code VARCHAR(50) NOT NULL UNIQUE,
    display_name VARCHAR(100) NOT NULL,
    description TEXT,
    
    -- 配置信息
    base_url VARCHAR(500),
    api_version VARCHAR(20),
    default_headers JSONB,
    rate_limit_config JSONB,
    
    -- 状态管理
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    is_system_default BOOLEAN DEFAULT FALSE,
    sort_order INT DEFAULT 0,
    
    -- 审计字段
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_ai_providers_code ON ai_providers(provider_code);
CREATE INDEX idx_ai_providers_status ON ai_providers(status);
CREATE INDEX idx_ai_providers_sort ON ai_providers(sort_order);
```

### 3. ai_models - AI模型表

```sql
CREATE TABLE ai_models (
    -- 主键
    model_id VARCHAR(36) NOT NULL PRIMARY KEY,
    
    -- 关联信息
    provider_id VARCHAR(36) NOT NULL,
    
    -- 模型信息
    model_name VARCHAR(100) NOT NULL,
    model_code VARCHAR(100) NOT NULL,
    display_name VARCHAR(100) NOT NULL,
    description TEXT,
    version VARCHAR(50),
    
    -- 模型规格
    context_window INT DEFAULT 4096,
    max_tokens INT DEFAULT 4096,
    input_price_per_token DECIMAL(10,8) DEFAULT 0,
    output_price_per_token DECIMAL(10,8) DEFAULT 0,
    
    -- 能力标识
    supports_streaming BOOLEAN DEFAULT TRUE,
    supports_function_calling BOOLEAN DEFAULT FALSE,
    supports_vision BOOLEAN DEFAULT FALSE,
    supports_json_mode BOOLEAN DEFAULT FALSE,
    
    -- 参数范围
    temperature_min DECIMAL(3,2) DEFAULT 0,
    temperature_max DECIMAL(3,2) DEFAULT 2,
    temperature_default DECIMAL(3,2) DEFAULT 0.7,
    
    -- 状态管理
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    is_recommended BOOLEAN DEFAULT FALSE,
    sort_order INT DEFAULT 0,
    
    -- 审计字段
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_ai_models_provider ON ai_models(provider_id);
CREATE INDEX idx_ai_models_code ON ai_models(model_code);
CREATE INDEX idx_ai_models_status ON ai_models(status);
CREATE INDEX idx_ai_models_recommended ON ai_models(is_recommended);
```

### 4. user_api_keys - 用户API密钥表

```sql
CREATE TABLE user_api_keys (
    -- 主键
    api_key_id VARCHAR(36) NOT NULL PRIMARY KEY,
    
    -- 关联信息
    user_id VARCHAR(36) NOT NULL,
    provider_id VARCHAR(36) NOT NULL,
    
    -- 密钥信息
    api_key_name VARCHAR(100) NOT NULL,
    encrypted_api_key TEXT NOT NULL,
    key_prefix VARCHAR(20),
    
    -- 配置信息
    is_default BOOLEAN DEFAULT FALSE,
    priority INT DEFAULT 1,
    
    -- 使用统计
    total_requests INT DEFAULT 0,
    total_tokens BIGINT DEFAULT 0,
    last_used_at TIMESTAMP,
    
    -- 状态管理
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    
    -- 审计字段
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(36) NOT NULL
);

-- 索引
CREATE INDEX idx_user_api_keys_user ON user_api_keys(user_id);
CREATE INDEX idx_user_api_keys_provider ON user_api_keys(provider_id);
CREATE INDEX idx_user_api_keys_status ON user_api_keys(user_id, status);
CREATE INDEX idx_user_api_keys_default ON user_api_keys(user_id, is_default);
```

### 5. sessions - 会话表

```sql
CREATE TABLE sessions (
    -- 主键
    session_id VARCHAR(36) NOT NULL PRIMARY KEY,
    
    -- 关联信息
    user_id VARCHAR(36) NOT NULL,
    
    -- 会话信息
    title VARCHAR(200),
    description TEXT,
    
    -- 模型配置
    model_id VARCHAR(36),
    provider_id VARCHAR(36),
    api_key_id VARCHAR(36),
    
    -- 参数设置
    temperature DECIMAL(3,2) DEFAULT 0.7,
    max_tokens INT,
    top_p DECIMAL(3,2),
    frequency_penalty DECIMAL(3,2),
    presence_penalty DECIMAL(3,2),
    
    -- 功能开关
    enable_knowledge_base BOOLEAN DEFAULT FALSE,
    knowledge_base_ids TEXT,
    enable_function_calling BOOLEAN DEFAULT FALSE,
    
    -- 统计信息
    message_count INT DEFAULT 0,
    total_input_tokens BIGINT DEFAULT 0,
    total_output_tokens BIGINT DEFAULT 0,
    
    -- 状态管理
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    is_pinned BOOLEAN DEFAULT FALSE,
    last_message_at TIMESTAMP,
    
    -- 审计字段
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(36) NOT NULL
);

-- 索引
CREATE INDEX idx_sessions_user ON sessions(user_id);
CREATE INDEX idx_sessions_status ON sessions(user_id, status);
CREATE INDEX idx_sessions_last_message ON sessions(user_id, last_message_at DESC);
CREATE INDEX idx_sessions_model ON sessions(model_id);
CREATE INDEX idx_sessions_pinned ON sessions(user_id, is_pinned);
```

### 6. conversations - 对话记录表

```sql
CREATE TABLE conversations (
    -- 主键
    conversation_id VARCHAR(36) NOT NULL PRIMARY KEY,
    
    -- 关联信息
    session_id VARCHAR(36) NOT NULL,
    user_id VARCHAR(36) NOT NULL,
    
    -- 对话信息
    role VARCHAR(20) NOT NULL,
    content TEXT NOT NULL,
    content_type VARCHAR(20) DEFAULT 'text',
    
    -- 序号信息
    sequence_number INT NOT NULL,
    parent_id VARCHAR(36),
    
    -- 模型调用信息（仅AI回复）
    model_id VARCHAR(36),
    provider_id VARCHAR(36),
    model_name VARCHAR(100),
    
    -- Token统计（仅AI回复）
    input_tokens INT DEFAULT 0,
    output_tokens INT DEFAULT 0,
    total_tokens INT DEFAULT 0,
    
    -- 性能指标（仅AI回复）
    response_time_ms INT DEFAULT 0,
    
    -- 扩展信息
    metadata JSONB,
    attachments JSONB,
    
    -- 反馈信息
    user_rating INT,
    user_feedback TEXT,
    
    -- 状态管理
    status VARCHAR(20) NOT NULL DEFAULT 'normal',
    
    -- 审计字段
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_conversations_session ON conversations(session_id);
CREATE INDEX idx_conversations_user ON conversations(user_id);
CREATE INDEX idx_conversations_sequence ON conversations(session_id, sequence_number);
CREATE INDEX idx_conversations_role ON conversations(session_id, role);
CREATE INDEX idx_conversations_created_at ON conversations(created_at);
CREATE INDEX idx_conversations_parent ON conversations(parent_id);
```

### 7. knowledge_bases - 知识库表

```sql
CREATE TABLE knowledge_bases (
    -- 主键
    kb_id VARCHAR(36) NOT NULL PRIMARY KEY,
    
    -- 关联信息
    user_id VARCHAR(36) NOT NULL,
    
    -- 基本信息
    kb_name VARCHAR(200) NOT NULL,
    description TEXT,
    
    -- 配置信息
    embedding_model VARCHAR(100) DEFAULT 'text-embedding-ada-002',
    chunk_size INT DEFAULT 1000,
    chunk_overlap INT DEFAULT 200,
    vector_dimension INT DEFAULT 1536,
    
    -- 统计信息
    document_count INT DEFAULT 0,
    total_chunks INT DEFAULT 0,
    total_size_bytes BIGINT DEFAULT 0,
    
    -- 状态管理
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    is_public BOOLEAN DEFAULT FALSE,
    
    -- 审计字段
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(36) NOT NULL
);

-- 索引
CREATE INDEX idx_knowledge_bases_user ON knowledge_bases(user_id);
CREATE INDEX idx_knowledge_bases_status ON knowledge_bases(status);
CREATE INDEX idx_knowledge_bases_public ON knowledge_bases(is_public);
CREATE INDEX idx_knowledge_bases_name ON knowledge_bases(kb_name);
```

### 8. documents - 文档表

```sql
CREATE TABLE documents (
    -- 主键
    document_id VARCHAR(36) NOT NULL PRIMARY KEY,
    
    -- 关联信息
    kb_id VARCHAR(36) NOT NULL,
    user_id VARCHAR(36) NOT NULL,
    
    -- 文档信息
    file_name VARCHAR(255) NOT NULL,
    original_name VARCHAR(255) NOT NULL,
    file_type VARCHAR(50) NOT NULL,
    file_size BIGINT NOT NULL,
    file_path VARCHAR(1000),
    file_url VARCHAR(1000),
    
    -- 内容信息
    title VARCHAR(500),
    content_preview TEXT,
    total_pages INT,
    total_characters INT,
    
    -- 处理状态
    processing_status VARCHAR(20) DEFAULT 'pending',
    processing_progress INT DEFAULT 0,
    processing_error TEXT,
    
    -- 分块信息
    chunk_count INT DEFAULT 0,
    embedding_status VARCHAR(20) DEFAULT 'pending',
    
    -- 元数据
    metadata JSONB,
    
    -- 状态管理
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    
    -- 审计字段
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(36) NOT NULL
);

-- 索引
CREATE INDEX idx_documents_kb ON documents(kb_id);
CREATE INDEX idx_documents_user ON documents(user_id);
CREATE INDEX idx_documents_status ON documents(status);
CREATE INDEX idx_documents_processing ON documents(processing_status);
CREATE INDEX idx_documents_embedding ON documents(embedding_status);
CREATE INDEX idx_documents_file_type ON documents(file_type);
CREATE INDEX idx_documents_created_at ON documents(created_at);
```

### 9. document_chunks - 文档分块表

```sql
CREATE TABLE document_chunks (
    -- 主键
    chunk_id VARCHAR(36) NOT NULL PRIMARY KEY,
    
    -- 关联信息
    document_id VARCHAR(36) NOT NULL,
    kb_id VARCHAR(36) NOT NULL,
    
    -- 分块信息
    chunk_index INT NOT NULL,
    content TEXT NOT NULL,
    content_length INT NOT NULL,
    
    -- 位置信息
    start_page INT,
    end_page INT,
    start_offset INT,
    end_offset INT,
    
    -- 向量信息
    embedding VECTOR(1536),
    embedding_model VARCHAR(100),
    
    -- 元数据
    metadata JSONB,
    
    -- 统计信息
    search_count INT DEFAULT 0,
    last_searched_at TIMESTAMP,
    
    -- 审计字段
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_document_chunks_document ON document_chunks(document_id);
CREATE INDEX idx_document_chunks_kb ON document_chunks(kb_id);
CREATE INDEX idx_document_chunks_index ON document_chunks(document_id, chunk_index);

-- 向量相似度搜索索引（需要pgvector扩展）
CREATE INDEX idx_document_chunks_embedding ON document_chunks 
USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);
```

### 10. system_configs - 系统配置表

```sql
CREATE TABLE system_configs (
    -- 主键
    config_id VARCHAR(36) NOT NULL PRIMARY KEY,
    
    -- 配置信息
    config_key VARCHAR(100) NOT NULL UNIQUE,
    config_value TEXT,
    config_type VARCHAR(20) NOT NULL DEFAULT 'string',
    
    -- 描述信息
    display_name VARCHAR(200),
    description TEXT,
    group_name VARCHAR(100),
    
    -- 约束信息
    is_required BOOLEAN DEFAULT FALSE,
    is_encrypted BOOLEAN DEFAULT FALSE,
    validation_rule TEXT,
    
    -- 状态管理
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    
    -- 审计字段
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by VARCHAR(36)
);

-- 索引
CREATE INDEX idx_system_configs_key ON system_configs(config_key);
CREATE INDEX idx_system_configs_group ON system_configs(group_name);
CREATE INDEX idx_system_configs_status ON system_configs(status);
```

## 初始化数据

### AI服务提供商初始数据

```sql
INSERT INTO ai_providers (provider_id, provider_name, provider_code, display_name, description, base_url, status, is_system_default, sort_order) VALUES
('openai-001', 'OpenAI', 'openai', 'OpenAI', 'OpenAI GPT models', 'https://api.openai.com', 'ACTIVE', TRUE, 1),
('anthropic-001', 'Anthropic', 'anthropic', 'Anthropic', 'Claude models', 'https://api.anthropic.com', 'ACTIVE', FALSE, 2),
('google-001', 'Google', 'google', 'Google', 'Gemini models', 'https://generativelanguage.googleapis.com', 'ACTIVE', FALSE, 3),
('zhipu-001', '智谱AI', 'zhipu', '智谱AI', 'GLM models', 'https://open.bigmodel.cn', 'ACTIVE', FALSE, 4);
```

### AI模型初始数据

```sql
INSERT INTO ai_models (model_id, provider_id, model_name, model_code, display_name, description, context_window, max_tokens, supports_streaming, is_recommended, sort_order) VALUES
('gpt-4-001', 'openai-001', 'gpt-4', 'gpt-4', 'GPT-4', 'Most capable GPT-4 model', 8192, 4096, TRUE, TRUE, 1),
('gpt-35-001', 'openai-001', 'gpt-3.5-turbo', 'gpt-3.5-turbo', 'GPT-3.5 Turbo', 'Fast and efficient model', 4096, 2048, TRUE, TRUE, 2),
('claude3-001', 'anthropic-001', 'claude-3-opus-20240229', 'claude-3-opus', 'Claude 3 Opus', 'Most intelligent Claude model', 200000, 4096, TRUE, TRUE, 3);
```

## 数据关系说明

1. **用户体系**: users → user_api_keys → sessions → conversations
2. **模型体系**: ai_providers → ai_models ← sessions
3. **知识库体系**: users → knowledge_bases → documents → document_chunks
4. **会话体系**: users → sessions → conversations

## 性能优化建议

1. **分区策略**: conversations表按时间分区，提升查询性能
2. **缓存策略**: 用户配置、模型信息等热点数据缓存
3. **索引优化**: 根据查询模式优化复合索引
4. **数据归档**: 定期归档历史对话数据
5. **向量优化**: 使用pgvector扩展优化向量搜索性能

---

*文档版本：v1.0*  
*创建时间：2025-07-22*  
*维护人员：开发团队*